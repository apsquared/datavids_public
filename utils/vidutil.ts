import { UserVideoDef } from "@/types/uservideodef";
import {
    getRenderProgress,
    renderMediaOnLambda,
  } from "@remotion/lambda/client";

const functionName = 'remotion-render-4-0-72-mem2048mb-disk2048mb-300sec';
   

export async function startLambda(videoDef:UserVideoDef):Promise<{renderId:string,bucketName:string}>{

    console.log("VIDEO DEF "+JSON.stringify(videoDef));

    console.log ("REMOTION ACCESS KEY" + process.env.REMOTION_AWS_ACCESS_KEY_ID);
    const { renderId, bucketName } = await renderMediaOnLambda({
        region: "us-east-1",
        functionName,
        serveUrl: 'https://remotionlambda-useast1-mxkhjz73v9.s3.us-east-1.amazonaws.com/sites/datavids/index.html',
        composition: "DataVids",
        inputProps: {...videoDef},
        codec: "h264",
        imageFormat: "jpeg",
        maxRetries: 1,
        timeoutInMilliseconds: 300000,
        framesPerLambda: 10,
        privacy: "public",
        logLevel:'verbose',
        downloadBehavior:{
          type:"download",
          fileName:"datavids.mp4"
        },
        envVariables:{
            AZURE_TTS_REGION:"eastus",
            AWS_REGION:"us-east-1",
            AWS_S3_REGION:"us-east-1",
            AWS_S3_BUCKET_NAME:"ap2mytts",
            AZURE_TTS_KEY:process.env.AZURE_TTS_KEY as string,
            AWS_ACCESS_KEY_ID: process.env.AWS_ACCESS_KEY_ID as string,
            AWS_SECRET_ACCESS_KEY: process.env.AWS_SECRET_ACCESS_KEY as string,
        }
        });
    
        console.log(renderId);

        return { renderId, bucketName };
}

export async function getStatus(renderId:string, bucketName:string):Promise<{status:string,details:string}> {

    const progress = await getRenderProgress({
        renderId,
        bucketName:bucketName,
        functionName,
        region: "us-east-1",
      });
      console.log("PROGRESS "+JSON.stringify(progress));
      if (progress.done) {
        console.log("Render finished!", progress.outputFile);
        return {status:'complete',details:progress.outputFile as string};
    
      }
      if (progress.fatalErrorEncountered) {
        console.error("Error enountered", progress.errors);
        const err = progress.errors
        return {status:'error', details: err[0].message  };
    
      }

      console.log(renderId);    

      return {status:'in progress', details: ''+progress.overallProgress };
}

/*
{ "framesRendered": 185, "chunks": 12, "done": false, "encodingStatus": null, 
"costs": { "accruedSoFar": 0.01312, "displayCost": "$0.013", "currency": "USD", "disclaimer": "Estimated cost only. Does not include charges for other AWS services." }, "renderId": "8k1e7pkm9l", 
"renderMetadata": { "startedDate": 1699205785885, "videoConfig": 
{ "id": "DataVids", "width": 1080, "height": 1920, "fps": 30, "durationInFrames": 210, "props": { "videoDef": { "videoname": "Copy of Prefilled Video1", "description": "Copy of Prefilled description", "videotype": "SINGLEITEM", "intro": { "image": "https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg", "duration": "2", "title": "My test item", "titlefont": { "fontname": "montserrat", "fontsize": 80, "fontcolor": "white", "bgcolor": "black" }, "subtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "subtitle": "This is a subtitle", "tts": { "ttstext": "testing", "voice": "enUSMan1" } }, "outro": { "image": "https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg", "duration": "2", "title": "Try out BarGPT.app", "titlefont": { "fontname": "montserrat", "fontsize": 80, "fontcolor": "white", "bgcolor": "black" }, "subtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "subtitle": "Follow for more" }, "body": { "itemduration": 3, "item": { "id": 0, "itemname": "My test item", "image": "https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1", "itemsubtitle": "Sub title for item", "itemdetails": "", "itemnamefont": { "fontname": "montserrat", "fontsize": 70, "fontcolor": "white", "bgcolor": "black" }, "itemsubtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "itemdetailsfont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "imageeffect": "SQUARE" }, "countBackwards": false }, "durationSec": 7 }, "videoname": "Copy of Prefilled Video1", "description": "Copy of Prefilled description", "videotype": "SINGLEITEM", "intro": { "image": "https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg", "duration": "2", "title": "My test item", "titlefont": { "fontname": "montserrat", "fontsize": 80, "fontcolor": "white", "bgcolor": "black" }, "subtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "subtitle": "This is a subtitle", "tts": { "ttstext": "testing", "voice": "enUSMan1" } }, "outro": { "image": "https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg", "duration": "2", "title": "Try out BarGPT.app", "titlefont": { "fontname": "montserrat", "fontsize": 80, "fontcolor": "white", "bgcolor": "black" }, "subtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "subtitle": "Follow for more" }, "body": { "itemduration": 3, "item": { "id": 0, "itemname": "My test item", "image": "https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1", "itemsubtitle": "Sub title for item", "itemdetails": "", "itemnamefont": { "fontname": "montserrat", "fontsize": 70, "fontcolor": "white", "bgcolor": "black" }, "itemsubtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "itemdetailsfont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "imageeffect": "SQUARE" }, "countBackwards": false }, "durationSec": 7 }, "defaultProps": { "videoDef": { "videoname": "Copy of Prefilled Video1", "description": "Copy of Prefilled description", "videotype": "SINGLEITEM", "intro": { "image": "https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg", "duration": "2", "title": "My test item", "titlefont": { "fontname": "montserrat", "fontsize": 80, "fontcolor": "white", "bgcolor": "black" }, "subtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "subtitle": "This is a subtitle", "tts": { "ttstext": "testing", "voice": "enUSMan1" } }, "outro": { "image": "https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg", "duration": "2", "title": "Try out BarGPT.app", "titlefont": { "fontname": "montserrat", "fontsize": 80, "fontcolor": "white", "bgcolor": "black" }, "subtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "subtitle": "Follow for more" }, "body": { "itemduration": 3, "item": { "id": 0, "itemname": "My test item", "image": "https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1", "itemsubtitle": "Sub title for item", "itemdetails": "", "itemnamefont": { "fontname": "montserrat", "fontsize": 70, "fontcolor": "white", "bgcolor": "black" }, "itemsubtitlefont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "itemdetailsfont": { "fontname": "montserrat", "fontsize": 50, "fontcolor": "white", "bgcolor": "black" }, "imageeffect": "SQUARE" }, "countBackwards": false }, "durationSec": 7 } }, 
"defaultCodec": null }, "totalChunks": 21, "estimatedTotalLambdaInvokations": 22, "estimatedRenderLambdaInvokations": 21, "compositionId": "DataVids", 
"siteId": "https://remotionlambda-useast1-mxkhjz73v9.s3.us-east-1.amazonaws.com/sites/datavids/index.html", "codec": "h264", "type": "video", 
"imageFormat": "jpeg", 
"inputProps": { "type": "payload", "payload": "{\"videoname\":\"Copy of Prefilled Video1\",\"description\":\"Copy of Prefilled description\",\"videotype\":\"SINGLEITEM\",\"intro\":{\"image\":\"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg\",\"duration\":\"2\",\"title\":\"My test item\",\"titlefont\":{\"fontname\":\"montserrat\",\"fontsize\":80,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitlefont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitle\":\"This is a subtitle\",\"tts\":{\"ttstext\":\"testing\",\"voice\":\"enUSMan1\"}},\"outro\":{\"image\":\"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg\",\"duration\":\"2\",\"title\":\"Try out BarGPT.app\",\"titlefont\":{\"fontname\":\"montserrat\",\"fontsize\":80,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitlefont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitle\":\"Follow for more\"},\"body\":{\"itemduration\":3,\"item\":{\"id\":0,\"itemname\":\"My test item\",\"image\":\"https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1\",\"itemsubtitle\":\"Sub title for item\",\"itemdetails\":\"\",\"itemnamefont\":{\"fontname\":\"montserrat\",\"fontsize\":70,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"itemsubtitlefont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"itemdetailsfont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"imageeffect\":\"SQUARE\"},\"countBackwards\":false},\"durationSec\":7}" }, "lambdaVersion": "4.0.62", "framesPerLambda": 10, "memorySizeInMb": 2048, "region": "us-east-1", "renderId": "8k1e7pkm9l", "privacy": "public", "everyNthFrame": 1, "frameRange": [0, 209], "audioCodec": null, "deleteAfter": null, "numberOfGifLoops": 0, "downloadBehavior": { "type": "play-in-browser" }, "audioBitrate": null }, "bucket": "remotionlambda-useast1-mxkhjz73v9", "outputFile": null, "timeToFinish": null, "errors": [], "fatalErrorEncountered": false, "currentTime": 1699205828885, "renderSize": 4931500, "lambdasInvoked": 21, "cleanup": null, 
"timeToFinishChunks": null, "overallProgress": 0.5517857142857142, "retriesInfo": [], "outKey": null, "outBucket": null, "mostExpensiveFrameRanges": null, "timeToEncode": null, "outputSizeInBytes": null, "type": "success" }
*/

/*
{"framesRendered":210,"bucket":"remotionlambda-useast1-mxkhjz73v9","renderSize":13920114,"chunks":21,"cleanup":{"doneIn":0,"filesDeleted":44,"minFilesToDelete":44},"costs":{"accruedSoFar":0.01155,"displayCost":"0.012","currency":"USD","disclaimer":"Estimated cost for lambda invocations only. Does not include cost for S3 storage and data transfer."},"currentTime":1699205858441,"done":true,"encodingStatus":{"framesEncoded":210},"errors":[],"fatalErrorEncountered":false,"lambdasInvoked":21,"outputFile":"https://s3.us-east-1.amazonaws.com/remotionlambda-useast1-mxkhjz73v9/renders/8k1e7pkm9l/out.mp4","renderId":"8k1e7pkm9l","renderMetadata":{"startedDate":1699205785885,"videoConfig":{"id":"DataVids","width":1080,"height":1920,"fps":30,"durationInFrames":210,"props":{"videoDef":{"videoname":"Copy of Prefilled Video1","description":"Copy of Prefilled description","videotype":"SINGLEITEM","intro":{"image":"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg","duration":"2","title":"My test item","titlefont":{"fontname":"montserrat","fontsize":80,"fontcolor":"white","bgcolor":"black"},"subtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"subtitle":"This is a subtitle","tts":{"ttstext":"testing","voice":"enUSMan1"}},"outro":{"image":"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg","duration":"2","title":"Try out BarGPT.app","titlefont":{"fontname":"montserrat","fontsize":80,"fontcolor":"white","bgcolor":"black"},"subtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"subtitle":"Follow for more"},"body":{"itemduration":3,"item":{"id":0,"itemname":"My test item","image":"https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1","itemsubtitle":"Sub title for item","itemdetails":"","itemnamefont":{"fontname":"montserrat","fontsize":70,"fontcolor":"white","bgcolor":"black"},"itemsubtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"itemdetailsfont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"imageeffect":"SQUARE"},"countBackwards":false},"durationSec":7},"videoname":"Copy of Prefilled Video1","description":"Copy of Prefilled description","videotype":"SINGLEITEM","intro":{"image":"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg","duration":"2","title":"My test item","titlefont":{"fontname":"montserrat","fontsize":80,"fontcolor":"white","bgcolor":"black"},"subtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"subtitle":"This is a subtitle","tts":{"ttstext":"testing","voice":"enUSMan1"}},"outro":{"image":"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg","duration":"2","title":"Try out BarGPT.app","titlefont":{"fontname":"montserrat","fontsize":80,"fontcolor":"white","bgcolor":"black"},"subtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"subtitle":"Follow for more"},"body":{"itemduration":3,"item":{"id":0,"itemname":"My test item","image":"https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1","itemsubtitle":"Sub title for item","itemdetails":"","itemnamefont":{"fontname":"montserrat","fontsize":70,"fontcolor":"white","bgcolor":"black"},"itemsubtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"itemdetailsfont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"imageeffect":"SQUARE"},"countBackwards":false},"durationSec":7},"defaultProps":{"videoDef":{"videoname":"Copy of Prefilled Video1","description":"Copy of Prefilled description","videotype":"SINGLEITEM","intro":{"image":"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg","duration":"2","title":"My test item","titlefont":{"fontname":"montserrat","fontsize":80,"fontcolor":"white","bgcolor":"black"},"subtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"subtitle":"This is a subtitle","tts":{"ttstext":"testing","voice":"enUSMan1"}},"outro":{"image":"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg","duration":"2","title":"Try out BarGPT.app","titlefont":{"fontname":"montserrat","fontsize":80,"fontcolor":"white","bgcolor":"black"},"subtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"subtitle":"Follow for more"},"body":{"itemduration":3,"item":{"id":0,"itemname":"My test item","image":"https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1","itemsubtitle":"Sub title for item","itemdetails":"","itemnamefont":{"fontname":"montserrat","fontsize":70,"fontcolor":"white","bgcolor":"black"},"itemsubtitlefont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"itemdetailsfont":{"fontname":"montserrat","fontsize":50,"fontcolor":"white","bgcolor":"black"},"imageeffect":"SQUARE"},"countBackwards":false},"durationSec":7}},"defaultCodec":null},"totalChunks":21,"estimatedTotalLambdaInvokations":22,"estimatedRenderLambdaInvokations":21,"compositionId":"DataVids","siteId":"https://remotionlambda-useast1-mxkhjz73v9.s3.us-east-1.amazonaws.com/sites/datavids/index.html","codec":"h264","type":"video","imageFormat":"jpeg","inputProps":{"type":"payload","payload":"{\"videoname\":\"Copy of Prefilled Video1\",\"description\":\"Copy of Prefilled description\",\"videotype\":\"SINGLEITEM\",\"intro\":{\"image\":\"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg\",\"duration\":\"2\",\"title\":\"My test item\",\"titlefont\":{\"fontname\":\"montserrat\",\"fontsize\":80,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitlefont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitle\":\"This is a subtitle\",\"tts\":{\"ttstext\":\"testing\",\"voice\":\"enUSMan1\"}},\"outro\":{\"image\":\"https://images.hdqwalls.com/download/morning-in-mountains-10k-ly-1080x1920.jpg\",\"duration\":\"2\",\"title\":\"Try out BarGPT.app\",\"titlefont\":{\"fontname\":\"montserrat\",\"fontsize\":80,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitlefont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"subtitle\":\"Follow for more\"},\"body\":{\"itemduration\":3,\"item\":{\"id\":0,\"itemname\":\"My test item\",\"image\":\"https://heybairtender.s3.amazonaws.com/recipes/mystic-smoke-burst.png?v=1\",\"itemsubtitle\":\"Sub title for item\",\"itemdetails\":\"\",\"itemnamefont\":{\"fontname\":\"montserrat\",\"fontsize\":70,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"itemsubtitlefont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"itemdetailsfont\":{\"fontname\":\"montserrat\",\"fontsize\":50,\"fontcolor\":\"white\",\"bgcolor\":\"black\"},\"imageeffect\":\"SQUARE\"},\"countBackwards\":false},\"durationSec\":7}"},"lambdaVersion":"4.0.62","framesPerLambda":10,"memorySizeInMb":2048,"region":"us-east-1","renderId":"8k1e7pkm9l","privacy":"public","everyNthFrame":1,"frameRange":[0,209],"audioCodec":null,"deleteAfter":null,"numberOfGifLoops":0,"downloadBehavior":{"type":"play-in-browser"},"audioBitrate":null},"timeToFinish":60570,"timeToFinishChunks":49205,"overallProgress":1,"retriesInfo":[],"outKey":"renders/8k1e7pkm9l/out.mp4","outBucket":"remotionlambda-useast1-mxkhjz73v9","mostExpensiveFrameRanges":[{"timeInMilliseconds":49205,"chunk":5,"frameRange":[50,59]},{"timeInMilliseconds":46334,"chunk":13,"frameRange":[130,139]},{"timeInMilliseconds":35814,"chunk":6,"frameRange":[60,69]},{"timeInMilliseconds":35242,"chunk":11,"frameRange":[110,119]},{"timeInMilliseconds":35079,"chunk":12,"frameRange":[120,129]}],"timeToEncode":938,"outputSizeInBytes":6419908,"type":"success"}
*/